"""Miscellaneous 2D matplotlib helpers.

Author: B.G.
"""

from typing import Literal

__all__ = [
    "convert_ticks_to_km",
    "add_grid_crosses",
    "add_colorbar",
    "finalize_figsize",
]


def convert_ticks_to_km(ax, axes: Literal["x", "y", "both"] = "both") -> None:
    """
    Convert axis tick labels from meters to kilometers.

    Parameters
    ----------
    ax : matplotlib.axes.Axes
        Axis to modify.
    axes : {'x', 'y', 'both'}
        Which axes to convert.
    """
    from matplotlib.ticker import FuncFormatter

    def km_formatter(x, _pos):
        return f"{x/1000:.1f}"

    if axes in ("x", "both"):
        ax.xaxis.set_major_formatter(FuncFormatter(km_formatter))
        xlabel = ax.get_xlabel()
        if xlabel and "m" in xlabel.lower() and "km" not in xlabel.lower():
            ax.set_xlabel(xlabel.replace("m", "km").replace("M", "km"))

    if axes in ("y", "both"):
        ax.yaxis.set_major_formatter(FuncFormatter(km_formatter))
        ylabel = ax.get_ylabel()
        if ylabel and "m" in ylabel.lower() and "km" not in ylabel.lower():
            ax.set_ylabel(ylabel.replace("m", "km").replace("M", "km"))
    _record_action(ax, {"type": "convert_ticks_to_km", "axes": axes})


def add_grid_crosses(
    ax,
    color="black",
    size=5,
    linewidth=1,
    alpha=0.47,
    include_minor: bool = True,
) -> None:
    """
    Add + signs at grid junction points defined by axis ticks.

    Parameters
    ----------
    ax : matplotlib.axes.Axes
        Axis to decorate.
    color : str or tuple
        Marker color.
    size : float
        Marker size.
    linewidth : float
        Line width of crosses.
    alpha : float
        Transparency of crosses.
    """
    xticks = list(ax.get_xticks())
    yticks = list(ax.get_yticks())

    if include_minor:
        xticks += list(ax.get_xticks(minor=True))
        yticks += list(ax.get_yticks(minor=True))

    xlim = ax.get_xlim()
    ylim = ax.get_ylim()

    xticks = [x for x in xticks if xlim[0] <= x <= xlim[1]]
    yticks = [y for y in yticks if ylim[0] <= y <= ylim[1]]

    minor_xticks = set(ax.get_xticks(minor=True)) if include_minor else set()
    minor_yticks = set(ax.get_yticks(minor=True)) if include_minor else set()

    for x in xticks:
        for y in yticks:
            is_minor = (x in minor_xticks) or (y in minor_yticks)
            marker_size = size * 0.6 if is_minor else size
            marker_alpha = alpha * 0.2 if is_minor else alpha
            ax.plot(
                x,
                y,
                "+",
                color=color,
                markersize=marker_size,
                markeredgewidth=linewidth,
                alpha=marker_alpha,
                zorder=100,
            )
    _record_action(
        ax,
        {
            "type": "add_grid_crosses",
            "color": color,
            "size": size,
            "linewidth": linewidth,
            "alpha": alpha,
            "include_minor": include_minor,
        },
    )


def _record_action(ax, action: dict) -> None:
    actions = getattr(ax, "_tpz_actions", None)
    if actions is None:
        actions = []
        setattr(ax, "_tpz_actions", actions)
    actions.append(action)


def add_colorbar(ax, im, label=None, fraction=0.035, pad=0.05, labelpad=5):
    """
    Attach a colorbar aligned to the height of the given axis.

    Parameters
    ----------
    ax : matplotlib.axes.Axes
        Axis associated with the image.
    im : matplotlib.image.AxesImage
        Image returned by imshow.
    label : str, optional
        Colorbar label.
    fraction : float, optional
        Fraction of original axes to use for the colorbar width.
    pad : float, optional
        Padding between axis and colorbar.
    """
    cbar = ax.figure.colorbar(
        im,
        ax=ax,
        fraction=fraction,
        pad=pad,
        shrink=0.9,
        anchor=(0.0, 0.5),
    )
    if label is not None:
        cbar.set_label(label, labelpad=labelpad)
    return cbar


def finalize_figsize(
    mappers,
    base_height: float = 6.0,
    base_width: float | None = None,
    min_width: float = 4.0,
    cbar_extra: float = 1.3,
) -> tuple[float, float]:
    """
    Pick a figure size based on mapper extents and colorbars.

    Parameters
    ----------
    mappers : Iterable[MapObject]
        MapObjects being plotted.
    base_height : float
        Default figure height in inches.
    base_width : float or None
        Base width (before aspect) in inches; multiplied by aspect ratio.
        Defaults to 70% of base_height when None.
    min_width : float
        Minimum figure width in inches.
    cbar_extra : float
        Additional width to reserve when a colorbar is present.
    """
    xs: list[float] = []
    ys: list[float] = []
    has_cbar = False
    for mapper in mappers:
        xmin, xmax, ymin, ymax = mapper.grid.extent
        xs.extend([xmin, xmax])
        ys.extend([ymin, ymax])
        has_cbar = has_cbar or isinstance(mapper.cbar, str)

    width = max(xs) - min(xs) if xs else 1.0
    height = max(ys) - min(ys) if ys else 1.0

    # Avoid degenerate aspect ratios
    if width <= 0:
        width = 1.0
    if height <= 0:
        height = 1.0

    aspect = width / height
    fig_height = base_height
    base_w = base_width if base_width is not None else 0.7 * base_height
    fig_width = max(min_width, base_w * aspect)

    if has_cbar:
        fig_width += cbar_extra

    return fig_width, fig_height
